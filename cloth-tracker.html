<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Cloth Tracker">
<title>‚öó Cloth Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --gold:#c8a84b;--gold-l:#f0d080;--gold-d:#7a6020;
  --bg:#0d0d12;--panel:#13131a;--card:#1a1a22;--card2:#20202a;
  --border:#2e2e3e;--border-g:rgba(200,168,75,.3);
  --moon:#7ec8e3;--shad:#9b59b6;--spell:#e74c3c;
  --ready:#2ecc71;--warn:#f39c12;--cd:#e74c3c;
  --text:#d4c9a0;--dim:#706858;--friend:#5d8aa8;
  --r:10px;
}
body{background:var(--bg);color:var(--text);font-family:'Crimson Text',Georgia,serif;min-height:100vh;}
input,select,button{font-family:inherit;font-size:1rem;}
button{cursor:pointer;}
input[type=checkbox]{width:22px;height:22px;accent-color:var(--gold);cursor:pointer;flex-shrink:0;}
select{-webkit-appearance:none;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border);}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header{text-align:center;padding:clamp(14px,4vw,24px) 16px 12px;
  border-bottom:1px solid var(--border-g);
  background:linear-gradient(180deg,rgba(200,168,75,.07) 0%,transparent 100%);}
h1{font-family:'Cinzel',serif;font-size:clamp(17px,5vw,24px);color:var(--gold-l);
  letter-spacing:.12em;text-shadow:0 0 28px rgba(200,168,75,.4);font-weight:700;}
.sub{color:var(--dim);font-size:11px;margin-top:3px;letter-spacing:.08em;}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.wrap{max-width:1160px;margin:0 auto;padding:14px 12px 60px;}

/* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
.sum-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.sum-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:10px 6px;text-align:center;position:relative;overflow:hidden;}
.sum-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sum-card.moon::after{background:var(--moon);}
.sum-card.shad::after{background:var(--shad);}
.sum-card.spell::after{background:var(--spell);}
.sum-name{font-family:'Cinzel',serif;font-size:clamp(8px,2vw,10px);letter-spacing:.15em;text-transform:uppercase;margin-bottom:4px;}
.sum-card.moon .sum-name{color:var(--moon);}
.sum-card.shad .sum-name{color:var(--shad);}
.sum-card.spell .sum-name{color:var(--spell);}
.sum-n{font-family:'Cinzel',serif;font-size:clamp(20px,5vw,28px);font-weight:700;color:var(--ready);line-height:1;}
.sum-of{font-size:10px;color:var(--dim);margin-top:2px;}
.sum-pcs{font-size:10px;color:var(--dim);}

/* ‚îÄ‚îÄ Alerts ‚îÄ‚îÄ */
#alerts{margin-bottom:12px;}
.alert{border-radius:8px;padding:10px 12px;font-size:13px;display:flex;
  align-items:flex-start;gap:8px;margin-bottom:7px;line-height:1.5;}
.alert.urgent{background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);}
.alert.warn{background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.28);}

/* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
.ctrl{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.search{background:var(--card);border:1px solid var(--border);color:var(--text);
  font-size:16px;padding:11px 13px;border-radius:var(--r);flex:1;min-width:120px;outline:none;}
.search::placeholder{color:var(--dim);}
.search:focus{border-color:var(--border-g);}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn{background:var(--card2);border:1px solid var(--border-g);color:var(--gold);
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:.08em;
  padding:11px 15px;border-radius:var(--r);min-height:44px;}
.btn:active{background:rgba(200,168,75,.2);}
.btn-p{background:rgba(200,168,75,.17);border:1px solid var(--gold);color:var(--gold-l);
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:.08em;
  padding:11px 15px;border-radius:var(--r);min-height:44px;}
.btn-p:active{background:rgba(200,168,75,.3);}
.btn-d{background:none;border:1px solid rgba(231,76,60,.4);color:var(--cd);
  font-family:'Cinzel',serif;font-size:10px;padding:7px 12px;border-radius:8px;min-height:36px;}
.btn-d:active{background:rgba(231,76,60,.15);}
.btn-g{background:none;border:1px dashed var(--border);color:var(--dim);
  font-size:13px;padding:8px 12px;border-radius:8px;min-height:36px;}
.btn-g:active{border-color:var(--gold-d);color:var(--gold);}
.btn-green{background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.4);color:var(--ready);
  font-family:'Cinzel',serif;font-size:11px;padding:11px 15px;border-radius:var(--r);min-height:44px;}
.icon-btn{background:none;border:none;color:var(--dim);font-size:20px;
  padding:4px 8px;min-width:38px;min-height:38px;display:inline-flex;align-items:center;justify-content:center;}
.icon-btn:active{color:var(--gold);}
.full{width:100%;display:block;text-align:center;padding:13px 15px;}

/* ‚îÄ‚îÄ Section label ‚îÄ‚îÄ */
.sec{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.18em;color:var(--dim);
  text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.sec::after{content:'';flex:1;height:1px;background:var(--border);}

/* ‚îÄ‚îÄ Char card ‚îÄ‚îÄ */
.char-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:11px;}
.char-card.mine{border-left:3px solid var(--gold);}
.char-card.friend{border-left:3px solid var(--friend);}
.char-hdr{display:flex;align-items:center;gap:7px;padding:10px 12px;background:var(--card2);flex-wrap:wrap;row-gap:5px;}
.bdg{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.08em;padding:3px 8px;border-radius:4px;text-transform:uppercase;white-space:nowrap;}
.bdg-mine{background:rgba(200,168,75,.14);color:var(--gold);border:1px solid var(--gold-d);}
.bdg-friend{background:rgba(93,138,168,.14);color:var(--friend);border:1px solid rgba(93,138,168,.38);}
.spec-bdg{font-family:'Cinzel',serif;font-size:9px;padding:3px 8px;border-radius:4px;text-transform:uppercase;white-space:nowrap;border:1px solid;}
.sp-none{color:var(--dim);border-color:var(--border);}
.sp-moon{color:var(--moon);border-color:rgba(126,200,227,.38);background:rgba(126,200,227,.07);}
.sp-shad{color:var(--shad);border-color:rgba(155,89,182,.38);background:rgba(155,89,182,.07);}
.sp-spell{color:var(--spell);border-color:rgba(231,76,60,.38);background:rgba(231,76,60,.07);}
.cname{font-family:'Cinzel',serif;font-size:14px;color:var(--gold-l);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cowner{font-size:12px;color:var(--dim);white-space:nowrap;}
.cstatus{font-size:11px;font-family:'Cinzel',serif;white-space:nowrap;}
.s-ready{color:var(--ready);}.s-some{color:var(--warn);}.s-none{color:var(--cd);}

/* ‚îÄ‚îÄ Cloth grid ‚îÄ‚îÄ */
.cloth-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);}
@media(max-width:560px){.cloth-grid{grid-template-columns:1fr;}}
.cc{background:var(--card);padding:12px 13px;display:flex;flex-direction:column;gap:5px;}
.cc.off{opacity:.3;}
.cl-row{display:flex;align-items:center;gap:6px;}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.d-moon{background:var(--moon);}.d-shad{background:var(--shad);}.d-spell{background:var(--spell);}
.cl-name{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.14em;text-transform:uppercase;}
.cl-name.moon{color:var(--moon);}.cl-name.shad{color:var(--shad);}.cl-name.spell{color:var(--spell);}
.fbadges{display:flex;gap:4px;flex-wrap:wrap;}
.fb{font-size:9px;padding:2px 6px;border-radius:3px;white-space:nowrap;font-family:'Cinzel',serif;}
.fb-s{background:rgba(200,168,75,.11);color:var(--gold);border:1px solid var(--gold-d);}
.fb-r{background:rgba(46,204,113,.09);color:var(--ready);border:1px solid rgba(46,204,113,.28);}
.cl-yield{font-size:12px;color:var(--dim);}
.cl-yield b{color:var(--gold-l);}
.cl-yield .st{color:var(--gold);font-size:11px;}
.cl-time{font-size:clamp(15px,4vw,17px);font-weight:700;}
.t-ready{color:var(--ready);}.t-soon{color:var(--warn);}.t-wait{color:var(--cd);}
.pbar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.pfill{height:100%;border-radius:2px;transition:width 1s linear;}
.pf-moon{background:var(--moon);}.pf-shad{background:var(--shad);}.pf-spell{background:var(--spell);}

/* ‚îÄ‚îÄ Sync bar ‚îÄ‚îÄ */
#sync-bar{font-size:12px;color:var(--dim);padding:6px 0;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.sdot.ok{background:var(--ready);}
.sdot.err{background:var(--cd);}
.sdot.spin{background:var(--warn);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);
  z-index:200;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}
.overlay.open{display:flex;}
@media(min-width:561px){.overlay{align-items:center;padding:16px;}}
.mbox{background:var(--panel);border:1px solid var(--border-g);
  width:100%;max-width:520px;border-radius:16px 16px 0 0;
  padding:20px 18px 36px;max-height:90vh;overflow-y:auto;
  box-shadow:0 -6px 40px rgba(0,0,0,.6);}
@media(min-width:561px){.mbox{border-radius:13px;padding:24px 22px;box-shadow:0 20px 60px rgba(0,0,0,.7);}}
.drag{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
@media(min-width:561px){.drag{display:none;}}
.mtitle{font-family:'Cinzel',serif;color:var(--gold-l);font-size:17px;margin-bottom:16px;font-weight:600;}
.mlabel{display:block;font-size:13px;color:var(--dim);margin-bottom:5px;margin-top:14px;}
.minput{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);
  font-size:16px;padding:11px 12px;border-radius:8px;outline:none;}
.minput:focus{border-color:var(--border-g);}
.mselect{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);
  font-size:16px;padding:11px 12px;border-radius:8px;outline:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23706858' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:34px;}
.mactions{display:flex;gap:10px;margin-top:14px;}
.mactions .btn,.mactions .btn-p{flex:1;text-align:center;}
hr.dv{border:none;border-top:1px solid var(--border);margin:14px 0;}
.tab-row{display:flex;gap:8px;margin-bottom:16px;}
.tab-btn{flex:1;padding:10px 8px;border-radius:8px;border:1px solid var(--border);color:var(--dim);font-size:13px;background:none;}
.tab-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(200,168,75,.1);}
.ccrow{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;}
.ccrow.off{opacity:.45;}
.ccrow-top{display:flex;align-items:center;gap:10px;}
.ccrow-lbl{display:flex;align-items:center;gap:6px;flex:1;}
.ccrow-chk{display:flex;align-items:center;gap:8px;font-size:15px;color:var(--text);}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
@media(max-width:480px){.two-col{grid-template-columns:1fr;gap:8px;}}
.slabel{font-size:12px;color:var(--dim);margin-bottom:4px;}
.sinput{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);
  font-size:15px;padding:9px 10px;border-radius:6px;outline:none;}
.sinput:focus{border-color:var(--border-g);}

/* ‚îÄ‚îÄ CD time-remaining inputs ‚îÄ‚îÄ */
.cd-fields{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0 6px;}
.cd-field label{display:block;font-size:11px;color:var(--dim);margin-bottom:4px;text-align:center;letter-spacing:.08em;text-transform:uppercase;}
.cd-num{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);
  font-size:22px;font-weight:700;padding:10px 6px;border-radius:8px;outline:none;text-align:center;
  -moz-appearance:textfield;}
.cd-num::-webkit-inner-spin-button,.cd-num::-webkit-outer-spin-button{-webkit-appearance:none;}
.cd-num:focus{border-color:var(--border-g);}

/* ‚îÄ‚îÄ Setup screen ‚îÄ‚îÄ */
#setup-screen{padding:20px 16px 40px;}
.setup-card{background:var(--card);border:1px solid var(--border-g);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.setup-card h2{font-family:'Cinzel',serif;color:var(--gold-l);font-size:15px;margin-bottom:12px;letter-spacing:.08em;}
.step{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start;}
.step-n{font-family:'Cinzel',serif;color:var(--gold);font-size:14px;font-weight:700;min-width:22px;padding-top:1px;}
.step-b{font-size:14px;line-height:1.65;flex:1;color:var(--text);}
.step-b b{color:var(--gold-l);}
.step-b a{color:var(--moon);text-decoration:underline;}
.code-block{background:var(--bg);border:1px solid var(--border);border-radius:6px;
  padding:10px 12px;font-family:monospace;font-size:11px;color:#a0c8a0;
  line-height:1.5;margin:8px 0;white-space:pre;overflow-x:auto;max-height:180px;overflow-y:auto;}
.copy-code{font-size:12px;padding:5px 12px;border-radius:6px;
  background:rgba(160,200,160,.1);border:1px solid rgba(160,200,160,.3);color:#a0c8a0;cursor:pointer;}
.hint{font-size:12px;color:var(--dim);margin-top:6px;line-height:1.5;}

/* ‚îÄ‚îÄ Share link blocks ‚îÄ‚îÄ */
.link-block{background:var(--card);border-radius:8px;padding:14px;margin-bottom:12px;}
.link-lbl{font-size:14px;margin-bottom:3px;font-weight:600;}
.link-desc{font-size:12px;color:var(--dim);margin-bottom:8px;line-height:1.5;}
.link-url{background:var(--bg);border:1px solid var(--border);border-radius:6px;
  padding:8px 10px;font-size:11px;color:var(--dim);font-family:monospace;
  word-break:break-all;margin-bottom:8px;line-height:1.4;user-select:all;-webkit-user-select:all;}
.copy-btn{width:100%;padding:10px;border-radius:6px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:.04em;cursor:pointer;}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--card2);border:1px solid var(--border-g);color:var(--gold-l);
  padding:10px 20px;border-radius:10px;font-size:14px;z-index:500;
  white-space:nowrap;opacity:0;transition:all .25s;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.5);}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setup-screen" style="display:none">
  <header><h1>‚öó Cloth Tracker</h1><div class="sub">TBC Anniversary ¬∑ First-Time Setup</div></header>
  <div class="wrap">
    <div class="setup-card">
      <h2>‚öô One-Time Setup ‚Äî About 5 Minutes</h2>
      <p style="font-size:14px;color:var(--dim);line-height:1.65;margin-bottom:18px;">
        This tracker stores data in a Google Sheet so every device and every shared link always
        shows the same live cooldowns. You only do this once.
      </p>

      <div class="step">
        <div class="step-n">1</div>
        <div class="step-b">Go to <a href="https://sheets.google.com" target="_blank">sheets.google.com</a>
          and create a new blank spreadsheet. Name it anything ‚Äî e.g. <b>"Cloth Tracker"</b>.</div>
      </div>

      <div class="step">
        <div class="step-n">2</div>
        <div class="step-b">In the spreadsheet, click <b>Extensions ‚Üí Apps Script</b>.
          Delete all existing code in the editor, paste the code below, then click the
          <b>Save</b> icon (üíæ).<br><br>
          <div class="code-block" id="script-code-display"></div>
          <button class="copy-code" onclick="copyScript()">üìã Copy Script Code</button>
        </div>
      </div>

      <div class="step">
        <div class="step-n">3</div>
        <div class="step-b">Click <b>Deploy ‚Üí New deployment</b>.
          Set type to <b>Web app</b>. Set <b>Execute as: Me</b> and
          <b>Who has access: Anyone</b>. Click <b>Deploy</b> and authorize when prompted.
          (Click "Advanced ‚Üí Go to [script name]" if you see a warning ‚Äî it's safe, it's your own script.)</div>
      </div>

      <div class="step">
        <div class="step-n">4</div>
        <div class="step-b">Copy the <b>Web app URL</b> shown after deploying and paste it here:</div>
      </div>

      <input type="url" class="minput" id="setup-url"
        placeholder="https://script.google.com/macros/s/‚Ä¶/exec"
        autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
        style="margin-bottom:8px">
      <div class="hint">This gets saved in your browser and embedded in every share link automatically ‚Äî your friends won't need to do any setup.</div>
      <br>
      <button class="btn-p full" onclick="completeSetup()">Connect to Google Sheet ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app" style="display:none">
  <header><h1>‚öó Cloth Tracker</h1><div class="sub">TBC Anniversary ¬∑ Tailoring Specializations</div></header>
  <div class="wrap">

    <!-- Role banner -->
    <div id="role-banner" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      border-radius:8px;padding:10px 14px;margin-bottom:12px;">
      <span id="role-icon" style="font-size:18px"></span>
      <span id="role-text" style="flex:1;font-size:13px"></span>
      <button class="btn-green" id="share-btn" onclick="openModal('share-modal')" style="display:none;padding:8px 14px;min-height:36px;font-size:11px;">üîó Share</button>
      <button class="btn" id="settings-btn" onclick="openModal('settings-modal')" style="display:none;padding:8px 12px;min-height:36px;font-size:10px;">‚öô</button>
    </div>

    <!-- Sync status -->
    <div id="sync-bar">
      <span class="sdot spin" id="sdot"></span>
      <span id="sync-txt">Connecting‚Ä¶</span>
      <button onclick="syncNow()" style="background:none;border:none;color:var(--dim);font-size:12px;margin-left:auto;text-decoration:underline;cursor:pointer;">‚Ü∫ Refresh</button>
    </div>

    <!-- Summary -->
    <div class="sum-grid">
      <div class="sum-card moon"><div class="sum-name">Mooncloth</div>
        <div class="sum-n" id="sum-moon-n">‚Äì</div>
        <div class="sum-of" id="sum-moon-of"></div><div class="sum-pcs" id="sum-moon-pcs"></div></div>
      <div class="sum-card shad"><div class="sum-name">Shadowcloth</div>
        <div class="sum-n" id="sum-shad-n">‚Äì</div>
        <div class="sum-of" id="sum-shad-of"></div><div class="sum-pcs" id="sum-shad-pcs"></div></div>
      <div class="sum-card spell"><div class="sum-name">Spellcloth</div>
        <div class="sum-n" id="sum-spell-n">‚Äì</div>
        <div class="sum-of" id="sum-spell-of"></div><div class="sum-pcs" id="sum-spell-pcs"></div></div>
    </div>

    <div id="alerts"></div>

    <div class="ctrl">
      <input type="text" class="search" id="search" placeholder="Filter by name or owner‚Ä¶">
      <button class="btn" id="add-btn" onclick="openAddModal()" style="display:none">+ Add Character</button>
    </div>

    <div class="sec">My Characters</div>
    <div id="mine-grid"></div>
    <div class="sec" style="margin-top:20px">Friends' Characters</div>
    <div id="friends-grid"></div>

  </div>
</div>

<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê CD MODAL ‚ïê‚ïê‚ïê -->
<div class="overlay" id="cd-modal">
  <div class="mbox">
    <span class="drag"></span>
    <div class="mtitle" id="cd-title">Set Cooldown</div>

    <div class="tab-row">
      <button class="tab-btn active" id="cd-tab-rem" onclick="cdTab('rem')">‚è± Time Remaining</button>
      <button class="tab-btn" id="cd-tab-when" onclick="cdTab('when')">üïê Craft Time</button>
    </div>

    <!-- Time Remaining panel -->
    <div id="cd-panel-rem">
      <div style="font-size:13px;color:var(--dim);margin-bottom:8px">Enter how much time is <em>still left</em> on the cooldown:</div>
      <div class="cd-fields">
        <div class="cd-field"><label>Days</label><input type="number" class="cd-num" id="cd-d" min="0" max="3" value="0"></div>
        <div class="cd-field"><label>Hours</label><input type="number" class="cd-num" id="cd-h" min="0" max="23" value="0"></div>
        <div class="cd-field"><label>Mins</label><input type="number" class="cd-num" id="cd-m" min="0" max="59" value="0"></div>
      </div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:14px;text-align:center">Max cooldown: 3d 20h ¬∑ Leave all zeros to mark READY</div>
      <button class="btn-p full" onclick="saveCDRemaining()">Save Time Remaining</button>
    </div>

    <!-- Craft Time panel -->
    <div id="cd-panel-when" style="display:none">
      <div style="font-size:13px;color:var(--dim);margin-bottom:8px">When did you craft the cloth?</div>
      <input type="datetime-local" class="minput" id="cd-dt" style="margin-bottom:14px">
      <button class="btn-p full" onclick="saveCDCraftTime()">Save Craft Time</button>
    </div>

    <hr class="dv">
    <button class="btn-green full" onclick="saveCDReady()">‚úì Mark as READY right now</button>
    <div class="mactions"><button class="btn full" onclick="closeModal('cd-modal')">Cancel</button></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CHAR MODAL ‚ïê‚ïê‚ïê -->
<div class="overlay" id="char-modal">
  <div class="mbox">
    <span class="drag"></span>
    <div class="mtitle" id="char-modal-title">Add Character</div>
    <div class="tab-row" id="type-tabs">
      <button class="tab-btn active" id="tab-mine" onclick="setCharTab('mine')">üë§ My Character</button>
      <button class="tab-btn" id="tab-friend" onclick="setCharTab('friend')">ü§ù Friend's</button>
    </div>
    <input type="hidden" id="char-type" value="mine">
    <div class="two-col" style="margin-top:0">
      <div>
        <label class="mlabel">Character Name</label>
        <input type="text" class="minput" id="char-name" placeholder="e.g. Kaldoreth" autocomplete="off">
      </div>
      <div id="owner-col">
        <label class="mlabel">Friend / Owner</label>
        <input type="text" class="minput" id="char-owner" placeholder="e.g. Steve" autocomplete="off">
      </div>
    </div>
    <hr class="dv">
    <label class="mlabel">Tailoring Specialization</label>
    <select class="mselect" id="char-spec" onchange="updateSpecHint()">
      <option value="none">No Specialization</option>
      <option value="moon">Mooncloth Tailoring (2√ó Mooncloth)</option>
      <option value="shad">Shadoweave Tailoring (2√ó Shadowcloth)</option>
      <option value="spell">Spellfire Tailoring (2√ó Spellcloth)</option>
    </select>
    <div style="font-size:12px;color:var(--dim);margin-top:5px;line-height:1.5" id="spec-hint">1√ó each cloth per 3d 20h cooldown.</div>
    <hr class="dv">
    <div style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:.18em;color:var(--dim);text-transform:uppercase;margin-bottom:10px">Cloth Tracking</div>
    <div id="cloth-rows"></div>
    <div class="mactions">
      <button class="btn" onclick="closeModal('char-modal')">Cancel</button>
      <button class="btn-p" onclick="saveCharacter()">Save Character</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SHARE MODAL ‚ïê‚ïê‚ïê -->
<div class="overlay" id="share-modal">
  <div class="mbox">
    <span class="drag"></span>
    <div class="mtitle">üîó Share Tracker</div>
    <p style="font-size:13px;color:var(--dim);margin-bottom:14px;line-height:1.6">
      Send these links to your friends. The Google Sheet connection is already embedded ‚Äî
      they just click the link and it works, no setup needed.
    </p>
    <div id="share-links-content"></div>
    <div style="font-size:12px;color:var(--dim);padding:10px 12px;margin-bottom:14px;
      background:rgba(231,76,60,.06);border:1px solid rgba(231,76,60,.2);border-radius:6px;line-height:1.5;">
      ‚ö†Ô∏è Keep your Owner link private. Share the Friend or View-Only links with others.
    </div>
    <button class="btn-p full" onclick="closeModal('share-modal')">Done</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê -->
<div class="overlay" id="settings-modal">
  <div class="mbox">
    <span class="drag"></span>
    <div class="mtitle">‚öô Settings</div>
    <label class="mlabel">Google Apps Script URL</label>
    <input type="url" class="minput" id="settings-url"
      placeholder="https://script.google.com/macros/s/‚Ä¶/exec"
      autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
    <div style="font-size:12px;color:var(--dim);margin-top:6px;line-height:1.5">
      Update this if you re-deploy your script or switch sheets.
    </div>
    <div class="mactions">
      <button class="btn" onclick="closeModal('settings-modal')">Cancel</button>
      <button class="btn-p" onclick="saveSettings()">Save & Reconnect</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CD_MS   = 92 * 3600 * 1000;  // 3 days 20 hours
const WARN_MS =  4 * 3600 * 1000;
const TYPES   = ["moon","shad","spell"];
const TNAME   = {moon:"Mooncloth", shad:"Shadowcloth", spell:"Spellcloth"};
const SNAME   = {none:"No Spec", moon:"Mooncloth Tailoring", shad:"Shadoweave Tailoring", spell:"Spellfire Tailoring"};
const LS_URL  = "ctracker-url";
const LS_KEYS = "ctracker-keys";

// Apps Script code shown in setup
const SCRIPT_CODE =
`function doGet(e)  { return handle(e); }
function doPost(e) { return handle(e); }
function handle(e) {
  var sheet = SpreadsheetApp
    .getActiveSpreadsheet()
    .getSheetByName("TrackerData")
    || SpreadsheetApp.getActiveSpreadsheet().insertSheet("TrackerData");
  var p = e.parameter;
  var out;
  if (p.action === "read") {
    out = sheet.getRange("A1").getValue() || "{}";
  } else if (p.action === "write") {
    sheet.getRange("A1").setValue(p.payload);
    out = "ok";
  } else {
    out = "err:unknown";
  }
  return ContentService
    .createTextOutput(out)
    .setMimeType(ContentService.MimeType.TEXT);
}`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chars     = [];
let scriptUrl = "";
let role      = "owner";   // owner | friend | viewer
let keys      = {owner:"", friend:""};
let filterTx  = "";
let cdTarget  = null;      // {charId, cloth}
let editingId = null;
let autoTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PURE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const uid     = () => Math.random().toString(36).slice(2,10);
const yld     = (c,t) => c.spec===t ? 2 : 1;
const tLeft   = lc => { if(!lc) return 0; const r=CD_MS-(Date.now()-lc); return r>0?r:0; };
const fmtT    = ms => {
  if(ms<=0) return "READY";
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000);
  return h>=24 ? `${Math.floor(h/24)}d ${h%24}h` : `${h}h ${m}m`;
};
const tSt     = ms => ms<=0?"ready":ms<WARN_MS?"soon":"waiting";
const pct     = lc => !lc?100:Math.min(100,((Date.now()-lc)/CD_MS)*100);
const esc     = s  => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
const canEdit = () => role==="owner";
const canCD   = ct => role==="owner"||(role==="friend"&&ct==="friend");

function nowLocal() {
  const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,16);
}
function toast(msg) {
  const el=document.getElementById("toast");
  el.textContent=msg; el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),2500);
}
function setSyncUI(state, txt) {
  document.getElementById("sdot").className="sdot "+state;
  document.getElementById("sync-txt").textContent=txt;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// URL HELPERS
// Keys and script URL travel in the URL hash
// so they never hit the server (privacy) and
// don't break with encoding issues.
// Format: #s=SECRET&u=BASE64_SCRIPT_URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function readHash() {
  const p = new URLSearchParams(window.location.hash.replace(/^#/,""));
  return {
    secret:    p.get("s") || "",
    scriptB64: p.get("u") || "",
    role:      p.get("r") || ""
  };
}

function buildShareLink(r, secret) {
  // Base = everything before the hash
  const base = window.location.href.split("#")[0];
  // Encode script URL as base64 so special chars cause zero issues
  const u = btoa(unescape(encodeURIComponent(scriptUrl)));
  return `${base}#r=${encodeURIComponent(r)}&s=${encodeURIComponent(secret)}&u=${u}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEET I/O
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sheetRead() {
  const res = await fetch(`${scriptUrl}?action=read&_=${Date.now()}`);
  if(!res.ok) throw new Error(res.status);
  const txt = await res.text();
  if(!txt || txt==="{}" || txt==="") return null;
  return JSON.parse(txt);
}

async function sheetWrite(data) {
  const payload = JSON.stringify(data);
  // Send as a GET with payload in query string (Apps Script handles both)
  const res = await fetch(`${scriptUrl}?action=write&payload=${encodeURIComponent(payload)}`);
  if(!res.ok) throw new Error(res.status);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncNow(silent=false) {
  if(!scriptUrl) return;
  if(!silent) setSyncUI("spin","Syncing‚Ä¶");
  try {
    const remote = await sheetRead();
    if(remote && remote.chars) {
      chars = remote.chars;
      migrate(chars);
      // Reconcile keys ‚Äî sheet's keys are authoritative
      if(remote.keys && remote.keys.owner) {
        keys = remote.keys;
        localStorage.setItem(LS_KEYS, JSON.stringify(keys));
        // Re-evaluate role now that we have real keys
        applyRole(readHash().secret);
        updateRoleUI();
      }
    } else if(!chars.length) {
      chars = defaultChars();
      await sheetWrite({chars, keys});
    }
    setSyncUI("ok","Synced ¬∑ "+new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}));
    render();
  } catch(e) {
    setSyncUI("err","Sync failed ‚Äî check Settings");
    if(!silent) toast("‚ö† Couldn't reach Google Sheet. Tap ‚öô to check the URL.");
  }
}

async function save() {
  setSyncUI("spin","Saving‚Ä¶");
  try {
    await sheetWrite({chars, keys});
    setSyncUI("ok","Saved ¬∑ "+new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}));
  } catch(e) {
    setSyncUI("err","Save failed");
    toast("‚ö† Couldn't save to Google Sheet.");
  }
}

function startAutoSync() {
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(()=>syncNow(true), 30000);
}

function migrate(arr) {
  arr.forEach(c=>{
    if(!c.spec) c.spec="none";
    TYPES.forEach(t=>{
      if(!c.cloths[t]) c.cloths[t]={tracked:false,sendTo:"",recvFrom:"",lastCraft:null};
      if(c.cloths[t].recvFrom===undefined) c.cloths[t].recvFrom="";
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function defaultChars() { return [
  {id:"me1",  name:"My Main",       type:"mine",   owner:"Me",      spec:"none", cloths:{
    moon:{tracked:true,  sendTo:"Friend2",recvFrom:"",  lastCraft:null},
    shad:{tracked:true,  sendTo:"",       recvFrom:"",  lastCraft:null},
    spell:{tracked:true, sendTo:"Friend1",recvFrom:"",  lastCraft:null}}},
  {id:"f1c1", name:"Friend1-Char1", type:"friend", owner:"Friend1", spec:"none", cloths:{
    moon:{tracked:false,sendTo:"",  recvFrom:"",  lastCraft:null},
    shad:{tracked:true, sendTo:"Me",recvFrom:"",  lastCraft:null},
    spell:{tracked:true,sendTo:"Me",recvFrom:"Me",lastCraft:null}}},
  {id:"f1c2", name:"Friend1-Char2", type:"friend", owner:"Friend1", spec:"none", cloths:{
    moon:{tracked:false,sendTo:"",  recvFrom:"",lastCraft:null},
    shad:{tracked:true, sendTo:"Me",recvFrom:"",lastCraft:null},
    spell:{tracked:true,sendTo:"Me",recvFrom:"",lastCraft:null}}},
  {id:"f2c1", name:"Friend2-Char1", type:"friend", owner:"Friend2", spec:"none", cloths:{
    moon:{tracked:false,sendTo:"",  recvFrom:"",  lastCraft:null},
    shad:{tracked:true, sendTo:"Me",recvFrom:"",  lastCraft:null},
    spell:{tracked:false,sendTo:"", recvFrom:"",  lastCraft:null}}},
  {id:"f3c1", name:"Friend3-Char1", type:"friend", owner:"Friend3", spec:"none", cloths:{
    moon:{tracked:false,sendTo:"",  recvFrom:"",lastCraft:null},
    shad:{tracked:true, sendTo:"Me",recvFrom:"",lastCraft:null},
    spell:{tracked:false,sendTo:"", recvFrom:"",lastCraft:null}}},
];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyRole(secret) {
  if(!secret)               role="owner";
  else if(secret===keys.owner)  role="owner";
  else if(secret===keys.friend) role="friend";
  else                      role="viewer";
}

function updateRoleUI() {
  const banner = document.getElementById("role-banner");
  const rc={owner:"rgba(200,168,75,.08)",friend:"rgba(93,138,168,.08)",viewer:"rgba(155,89,182,.08)"};
  const bc={owner:"rgba(200,168,75,.25)",friend:"rgba(93,138,168,.25)",viewer:"rgba(155,89,182,.25)"};
  const tc={owner:"#c8a84b",friend:"#5d8aa8",viewer:"#9b59b6"};
  banner.style.cssText=`display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    border-radius:8px;padding:10px 14px;margin-bottom:12px;
    background:${rc[role]};border:1px solid ${bc[role]};color:${tc[role]};`;
  document.getElementById("role-icon").textContent={owner:"üëë",friend:"ü§ù",viewer:"üëÅ"}[role];
  document.getElementById("role-text").textContent={
    owner:"Owner ‚Äî full edit access",
    friend:"Friend ‚Äî can reset cooldowns on friend characters",
    viewer:"Guest ‚Äî read only"
  }[role];
  const isOwner = role==="owner";
  document.getElementById("share-btn").style.display = isOwner?"":"none";
  document.getElementById("settings-btn").style.display = isOwner?"":"none";
  document.getElementById("add-btn").style.display = isOwner?"":"none";
}

function boot() {
  document.getElementById("script-code-display").textContent = SCRIPT_CODE;

  const hash = readHash();

  // Resolve script URL: hash param ‚Üí localStorage
  let fromHash = "";
  if(hash.scriptB64) {
    try { fromHash = decodeURIComponent(escape(atob(hash.scriptB64))); } catch{}
  }
  scriptUrl = fromHash || localStorage.getItem(LS_URL) || "";
  if(fromHash) localStorage.setItem(LS_URL, fromHash); // persist for next visit

  if(!scriptUrl) {
    document.getElementById("setup-screen").style.display="";
    return;
  }

  // Resolve keys: localStorage first, generate if missing
  try { keys = JSON.parse(localStorage.getItem(LS_KEYS)||"{}"); } catch{}
  if(!keys.owner)  keys.owner  = uid()+uid();
  if(!keys.friend) keys.friend = uid()+uid();
  localStorage.setItem(LS_KEYS, JSON.stringify(keys));

  // Initial role from hash secret (will be refined after sheet loads real keys)
  applyRole(hash.secret);

  document.getElementById("setup-screen").style.display="none";
  document.getElementById("app").style.display="";
  document.getElementById("settings-url").value=scriptUrl;
  updateRoleUI();

  // Wire up search + modal backdrop close
  document.getElementById("search").addEventListener("input",e=>{filterTx=e.target.value;render();});
  document.querySelectorAll(".overlay").forEach(el=>{
    el.addEventListener("click",e=>{ if(e.target===el) el.classList.remove("open"); });
  });

  syncNow();
  startAutoSync();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function completeSetup() {
  const val = document.getElementById("setup-url").value.trim();
  if(!val.startsWith("https://script.google.com")) {
    alert("Please paste the Web App URL from Google Apps Script.\nIt should start with: https://script.google.com");
    return;
  }
  localStorage.setItem(LS_URL, val);
  scriptUrl = val;
  boot();
}
function saveSettings() {
  const val = document.getElementById("settings-url").value.trim();
  if(!val.startsWith("https://")) { alert("Enter a valid URL."); return; }
  localStorage.setItem(LS_URL, val);
  scriptUrl = val;
  closeModal("settings-modal");
  syncNow();
  startAutoSync();
  toast("Reconnecting‚Ä¶");
}
function copyScript() {
  navigator.clipboard.writeText(SCRIPT_CODE)
    .then(()=>toast("Script code copied!"))
    .catch(()=>prompt("Copy this script code:",SCRIPT_CODE));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const f=filterTx.toLowerCase();
  const vis=t=>chars.filter(c=>c.type===t&&(!f||c.name.toLowerCase().includes(f)||c.owner.toLowerCase().includes(f)));
  const empty=`<div style="color:var(--dim);font-size:14px;padding:10px 4px">No characters.</div>`;
  document.getElementById("mine-grid").innerHTML    = vis("mine").length    ? vis("mine").map(renderChar).join("")    : empty;
  document.getElementById("friends-grid").innerHTML = vis("friend").length  ? vis("friend").map(renderChar).join("") : empty;
  renderSummary(); renderAlerts();
}

function renderChar(c) {
  const tracked=TYPES.filter(t=>c.cloths[t].tracked);
  const rN=tracked.filter(t=>tLeft(c.cloths[t].lastCraft)===0).length;
  const sc=!tracked.length?"s-none":rN===tracked.length?"s-ready":rN>0?"s-some":"s-none";
  const st=!tracked.length?"‚Äî":rN===tracked.length?"All Ready":`${rN}/${tracked.length} Ready`;
  const spCls={none:"sp-none",moon:"sp-moon",shad:"sp-shad",spell:"sp-spell"}[c.spec];
  const spTxt=c.spec!=="none"?`‚òÖ ${SNAME[c.spec]}`:"No Spec";
  const btns=canEdit()?`
    <button class="icon-btn" onclick="openEditModal('${c.id}')">‚úé</button>
    <button class="btn-d" onclick="removeChar('${c.id}')">‚úï</button>`:"";
  return `<div class="char-card ${c.type}">
    <div class="char-hdr">
      <span class="bdg bdg-${c.type}">${c.type==="mine"?"Mine":"Friend"}</span>
      <span class="spec-bdg ${spCls}">${esc(spTxt)}</span>
      <span class="cname">${esc(c.name)}</span>
      ${c.type==="friend"?`<span class="cowner">${esc(c.owner)}</span>`:""}
      <span class="cstatus ${sc}">${st}</span>
      ${btns}
    </div>
    <div class="cloth-grid">${TYPES.map(t=>renderCell(c,t)).join("")}</div>
  </div>`;
}

function renderCell(c,t) {
  const cl=c.cloths[t], isSpec=c.spec===t, qty=yld(c,t);
  if(!cl.tracked) return `<div class="cc off">
    <div class="cl-row"><span class="dot d-${t}"></span><span class="cl-name ${t}">${TNAME[t]}</span></div>
    <div style="font-size:12px;color:var(--dim)">Not tracked</div></div>`;
  const ms=tLeft(cl.lastCraft), st=tSt(ms), p=pct(cl.lastCraft);
  const sB=cl.sendTo?`<span class="fb fb-s">‚Üí ${esc(cl.sendTo)}</span>`:"";
  const rB=cl.recvFrom?`<span class="fb fb-r">‚Üê ${esc(cl.recvFrom)}</span>`:"";
  const btn=canCD(c.type)?`<button class="btn-g" onclick="openCDModal('${c.id}','${t}')" style="margin-top:2px">Set CD</button>`:"";
  return `<div class="cc">
    <div class="cl-row"><span class="dot d-${t}"></span>
      <span class="cl-name ${t}">${TNAME[t]}${isSpec?" ‚òÖ":""}</span></div>
    ${(sB||rB)?`<div class="fbadges">${sB}${rB}</div>`:""}
    <div class="cl-yield">Yields <b>${qty}√ó</b>${isSpec?` <span class="st">(‚òÖ spec)</span>`:""}</div>
    <div class="cl-time t-${st}">${fmtT(ms)}</div>
    <div class="pbar"><div class="pfill pf-${t}" style="width:${p}%"></div></div>
    ${btn}
  </div>`;
}

function renderSummary() {
  TYPES.forEach(t=>{
    const tracked=chars.filter(c=>c.cloths[t].tracked);
    const ready=tracked.filter(c=>tLeft(c.cloths[t].lastCraft)===0);
    const tot=tracked.reduce((s,c)=>s+yld(c,t),0);
    const rdy=ready.reduce((s,c)=>s+yld(c,t),0);
    document.getElementById(`sum-${t}-n`).textContent=ready.length;
    document.getElementById(`sum-${t}-of`).textContent=`of ${tracked.length} ready`;
    document.getElementById(`sum-${t}-pcs`).textContent=`${rdy}/${tot} pieces`;
  });
}

function renderAlerts() {
  const out=[];
  chars.forEach(c=>TYPES.forEach(t=>{
    const cl=c.cloths[t]; if(!cl.tracked) return;
    const ms=tLeft(cl.lastCraft), qty=yld(c,t);
    const who=c.type==="friend"?`${c.name} (${c.owner})`:c.name;
    if(ms===0){
      if(c.type==="friend"&&cl.recvFrom) out.push({cls:"urgent",icon:"üì¶",txt:`Send mats ‚Üí ${who}: ${qty}√ó ${TNAME[t]} READY`});
      else if(c.type==="friend"&&cl.sendTo) out.push({cls:"urgent",icon:"‚úÖ",txt:`${who}: ${qty}√ó ${TNAME[t]} READY ‚Üí ${cl.sendTo}`});
      else if(c.type==="mine"&&cl.sendTo) out.push({cls:"urgent",icon:"‚úÖ",txt:`Craft ${qty}√ó ${TNAME[t]} on ${who} ‚Üí send to ${cl.sendTo}`});
    } else if(ms<WARN_MS&&c.type==="friend"&&cl.recvFrom){
      out.push({cls:"warn",icon:"‚ö†Ô∏è",txt:`Prep mats for ${who}: ${qty}√ó ${TNAME[t]} ready in ${fmtT(ms)}`});
    }
  }));
  document.getElementById("alerts").innerHTML=out.map(a=>
    `<div class="alert ${a.cls}"><span style="font-size:15px;flex-shrink:0;margin-top:1px">${a.icon}</span><span>${esc(a.txt)}</span></div>`
  ).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CD MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCDModal(charId, cloth) {
  cdTarget={charId, cloth};
  const c=chars.find(x=>x.id===charId);
  document.getElementById("cd-title").textContent=`${c.name} ¬∑ ${TNAME[cloth]}`;
  // Pre-fill remaining time if cooldown is active
  const ms=tLeft(c.cloths[cloth].lastCraft);
  if(ms>0){
    const totalMin=Math.ceil(ms/60000);
    document.getElementById("cd-d").value=Math.floor(totalMin/1440);
    document.getElementById("cd-h").value=Math.floor((totalMin%1440)/60);
    document.getElementById("cd-m").value=totalMin%60;
  } else {
    document.getElementById("cd-d").value=0;
    document.getElementById("cd-h").value=0;
    document.getElementById("cd-m").value=0;
  }
  document.getElementById("cd-dt").value=nowLocal();
  cdTab("rem");
  openModal("cd-modal");
}

function cdTab(tab) {
  document.getElementById("cd-tab-rem").classList.toggle("active",tab==="rem");
  document.getElementById("cd-tab-when").classList.toggle("active",tab==="when");
  document.getElementById("cd-panel-rem").style.display=tab==="rem"?"":"none";
  document.getElementById("cd-panel-when").style.display=tab==="when"?"":"none";
}

async function saveCDRemaining() {
  const d=parseInt(document.getElementById("cd-d").value)||0;
  const h=parseInt(document.getElementById("cd-h").value)||0;
  const m=parseInt(document.getElementById("cd-m").value)||0;
  const remMs=(d*1440+h*60+m)*60000;
  if(remMs<=0){ await saveCDReady(); return; }
  if(remMs>CD_MS){ toast("‚ö† Max remaining time is 3d 20h."); return; }
  // Work backwards: lastCraft = now - (CD_MS - remMs)
  const lastCraft=Date.now()-(CD_MS-remMs);
  applyCD(lastCraft); toast("Cooldown updated.");
}

async function saveCDCraftTime() {
  const val=document.getElementById("cd-dt").value; if(!val) return;
  const lastCraft=new Date(val).getTime();
  if(Date.now()-lastCraft>=CD_MS){ await saveCDReady(); return; }
  applyCD(lastCraft); toast("Cooldown saved.");
}

async function saveCDReady() {
  applyCD(null); toast("Marked as ready.");
}

async function applyCD(lastCraft) {
  chars=chars.map(c=>c.id!==cdTarget.charId?c:
    {...c,cloths:{...c.cloths,[cdTarget.cloth]:{...c.cloths[cdTarget.cloth],lastCraft}}});
  closeModal("cd-modal"); render(); await save();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAR MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setCharTab(t) {
  document.getElementById("char-type").value=t;
  document.getElementById("tab-mine").classList.toggle("active",t==="mine");
  document.getElementById("tab-friend").classList.toggle("active",t==="friend");
  document.getElementById("owner-col").style.display=t==="friend"?"":"none";
}
function updateSpecHint() {
  const v=document.getElementById("char-spec").value;
  const h={none:"1√ó each cloth per 3d 20h cooldown.",
    moon:"2√ó Mooncloth, 1√ó others. (3d 20h CD)",
    shad:"2√ó Shadowcloth, 1√ó others. (3d 20h CD)",
    spell:"2√ó Spellcloth, 1√ó others. (3d 20h CD)"};
  document.getElementById("spec-hint").textContent=h[v];
}
function buildClothRows(existing) {
  document.getElementById("cloth-rows").innerHTML=TYPES.map(t=>{
    const cl=existing?existing.cloths[t]:{tracked:false,sendTo:"",recvFrom:""};
    const on=cl.tracked;
    return `<div class="ccrow${on?"":" off"}" id="ccrow-${t}">
      <div class="ccrow-top">
        <div class="ccrow-lbl"><span class="dot d-${t}"></span>
          <span class="cl-name ${t}" style="font-size:11px">${TNAME[t]}</span></div>
        <label class="ccrow-chk">
          <input type="checkbox" id="trk-${t}"${on?" checked":""} onchange="toggleCC('${t}')"> Track
        </label>
      </div>
      <div id="ccdet-${t}" style="${on?"":"display:none"}">
        <div class="two-col">
          <div><div class="slabel">Sends cloth to:</div>
            <input type="text" class="sinput" id="snd-${t}" value="${esc(cl.sendTo||"")}" placeholder="Me, Friend1‚Ä¶" autocomplete="off"></div>
          <div><div class="slabel">Receives mats from:</div>
            <input type="text" class="sinput" id="rcv-${t}" value="${esc(cl.recvFrom||"")}" placeholder="Me, or blank" autocomplete="off"></div>
        </div>
      </div>
    </div>`;
  }).join("");
}
function toggleCC(t) {
  const on=document.getElementById(`trk-${t}`).checked;
  document.getElementById(`ccrow-${t}`).classList.toggle("off",!on);
  document.getElementById(`ccdet-${t}`).style.display=on?"":"none";
}
function openAddModal() {
  editingId=null;
  document.getElementById("char-modal-title").textContent="Add Character";
  document.getElementById("char-name").value="";
  document.getElementById("char-owner").value="";
  document.getElementById("char-spec").value="none";
  updateSpecHint();
  document.getElementById("tab-mine").style.display="";
  document.getElementById("tab-friend").style.display="";
  setCharTab("mine"); buildClothRows(null);
  openModal("char-modal");
}
function openEditModal(id) {
  editingId=id;
  const c=chars.find(x=>x.id===id);
  document.getElementById("char-modal-title").textContent=`Edit: ${c.name}`;
  document.getElementById("char-name").value=c.name;
  document.getElementById("char-owner").value=c.owner;
  document.getElementById("char-spec").value=c.spec||"none";
  updateSpecHint();
  document.getElementById("tab-mine").style.display=c.type==="mine"?"":"none";
  document.getElementById("tab-friend").style.display=c.type==="friend"?"":"none";
  document.getElementById("tab-mine").classList.toggle("active",c.type==="mine");
  document.getElementById("tab-friend").classList.toggle("active",c.type==="friend");
  document.getElementById("char-type").value=c.type;
  document.getElementById("owner-col").style.display=c.type==="friend"?"":"none";
  buildClothRows(c); openModal("char-modal");
}
async function saveCharacter() {
  const name=document.getElementById("char-name").value.trim();
  if(!name){alert("Enter a character name.");return;}
  const type=document.getElementById("char-type").value;
  const owner=type==="mine"?"Me":(document.getElementById("char-owner").value.trim()||"Friend");
  const spec=document.getElementById("char-spec").value;
  const cloths={};
  TYPES.forEach(t=>{
    const lastCraft=editingId?(chars.find(c=>c.id===editingId)?.cloths[t]?.lastCraft??null):null;
    cloths[t]={
      tracked:document.getElementById(`trk-${t}`)?.checked||false,
      sendTo:document.getElementById(`snd-${t}`)?.value.trim()||"",
      recvFrom:document.getElementById(`rcv-${t}`)?.value.trim()||"",
      lastCraft
    };
  });
  const entry={name,type,owner,spec,cloths};
  chars=editingId&&chars.find(c=>c.id===editingId)
    ? chars.map(c=>c.id===editingId?{...c,...entry}:c)
    : [...chars,{...entry,id:"c"+Date.now()}];
  closeModal("char-modal"); render(); await save(); toast("Character saved.");
}
async function removeChar(id) {
  if(!confirm("Remove this character?")) return;
  chars=chars.filter(c=>c.id!==id);
  render(); await save(); toast("Removed.");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  if(id==="share-modal") buildShareLinks();
  document.getElementById(id).classList.add("open");
}
function closeModal(id){ document.getElementById(id).classList.remove("open"); }

function buildShareLinks() {
  const links=[
    {key:"owner", label:"üëë Owner Link",    desc:"Full access ‚Äî keep this for yourself only.", color:"#c8a84b", url:buildShareLink("owner",  keys.owner)},
    {key:"friend",label:"ü§ù Friend Link",   desc:"View everything + reset friend character cooldowns.", color:"#5d8aa8", url:buildShareLink("friend", keys.friend)},
    {key:"view",  label:"üëÅ View-Only",     desc:"Read-only. No changes allowed.",               color:"#9b59b6", url:buildShareLink("viewer", "view")},
  ];
  document.getElementById("share-links-content").innerHTML=links.map(l=>`
    <div class="link-block" style="border:1px solid ${l.color}22">
      <div class="link-lbl" style="color:${l.color}">${l.label}</div>
      <div class="link-desc">${l.desc}</div>
      <div class="link-url" id="lurl-${l.key}">${esc(l.url)}</div>
      <button class="copy-btn" id="cpbtn-${l.key}"
        style="background:${l.color}22;border:1px solid ${l.color}55;color:${l.color}"
        onclick="copyLink('${l.key}')">Copy Link</button>
    </div>`).join("");
}

function copyLink(key) {
  const url = document.getElementById(`lurl-${key}`).textContent;
  navigator.clipboard.writeText(url)
    .then(()=>{ const b=document.getElementById(`cpbtn-${key}`); b.textContent="‚úì Copied!"; setTimeout(()=>b.textContent="Copy Link",2000); })
    .catch(()=>prompt("Copy this link:",url));
}

boot();
</script>
</body>
</html>
